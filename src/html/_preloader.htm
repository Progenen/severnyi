<div id="fls-preloader">
  <script>
    function preloader() {
      const preloaderImages = document.querySelector("[data-preloader]")
        ? document.querySelectorAll("[data-preloader] img")
        : document.querySelectorAll("img");

      const preloaderContainer = document.querySelector("#fls-preloader");

      if (!preloaderImages.length) {
        preloaderContainer?.remove();
        return;
      }

      const preloaderTemplate = `
        <div class="fls-preloader">
          <div class="fls-preloader__body">
            <div class="fls-preloader__logo">
              <svg>
                <use xlink:href="img/icons/icons.svg#icon-star"></use>
              </svg>
            </div>
            <div class="fls-preloader__line"><span></span></div>
          </div>
        </div>`;

      document.documentElement.insertAdjacentHTML("beforeend", preloaderTemplate);

      const preloader = document.querySelector(".fls-preloader");
      const progressBar = document.querySelector(".fls-preloader__line span");
      const html = document.documentElement;

      let loadedCount = 0;
      let displayedProgress = 0;
      const total = preloaderImages.length;

      html.classList.add("loading", "lock");

      function updateProgress(target) {
        if (displayedProgress >= target) return;

        displayedProgress++;
        progressBar.style.width = displayedProgress + "%";

        if (displayedProgress >= 100) {
          html.classList.add("loaded");
          html.classList.remove("lock", "loading");

          setTimeout(() => {
            preloader.remove();
            preloaderContainer.remove();
          }, 900);
        }
      }

      function imageLoaded() {
        loadedCount++;
        const progress = Math.round((loadedCount / total) * 100);

        const interval = setInterval(() => {
          if (displayedProgress >= progress) {
            clearInterval(interval);
            return;
          }
          updateProgress(displayedProgress + 1);
        }, 12);
      }

      preloaderImages.forEach(img => {
        const clone = new Image();
        clone.onload = imageLoaded;
        clone.onerror = imageLoaded;
        clone.src = img.dataset.src || img.src;
      });

      setTimeout(() => {
        if (displayedProgress < 100) {
          const forceInterval = setInterval(() => {
            updateProgress(displayedProgress + 1);
            if (displayedProgress >= 100) clearInterval(forceInterval);
          }, 20);
        }
      }, 12000);
    }

    preloader();
  </script>
</div>